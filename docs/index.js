function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function changeLang(){const e=document.getElementById("lang"),t=e.options[e.selectedIndex].value;location.href=`/free-midi/${t}/`}class SoundFontPlayer{midi;context=new globalThis.AudioContext;state="stopped";loadedLibraries=!1;noCallback=!1;prevGain=.5;totalTicks=0;cacheUrls=new Array(128);constructor(e){this.stopCallback=e}async loadLibraries(){await loadLibraries(["https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.min.js","https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/dist/js-synthesizer.min.js","https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/externals/libfluidsynth-2.3.0-with-libsndfile.min.js"]),await this.context.audioWorklet.addModule("https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/externals/libfluidsynth-2.3.0-with-libsndfile.min.js"),await this.context.audioWorklet.addModule("https://cdn.jsdelivr.net/npm/js-synthesizer@1.8.5/dist/js-synthesizer.worklet.min.js"),this.synth=new JSSynth.AudioWorkletNodeSynthesizer,this.synth.init(this.context.sampleRate);const e=this.synth.createAudioNode(this.context);e.connect(this.context.destination),this.loaded=!0}async loadSoundFontDir(e,t){const n=e.map(e=>{const s=e.toString().padStart(3,"0"),n=`${t}/${s}.sf3`;return this.cacheUrls[e]==n||(this.cacheUrls[e]=n,this.fetchBuffer(n))}),s=await Promise.all(n);for(const e of s)e instanceof ArrayBuffer&&await this.loadSoundFontBuffer(e)}async fetchBuffer(e){const t=await fetch(e);return t.status==200?await t.arrayBuffer():void 0}async loadSoundFontUrl(e){const t=await this.fetchBuffer(e),n=await this.loadSoundFontBuffer(t);return n}async loadSoundFontBuffer(e){const t=await this.synth.loadSFont(e);return t}async loadNoteSequence(e){return await this.synth.resetPlayer(),this.midi=e,this.totalTicks=this.calcTick(e.duration),this.synth.addSMFDataToPlayer(e.toArray())}resumeContext(){this.context.resume()}async restart(e){this.state="started",await this.synth.playPlayer(),e&&this.seekTo(e),await this.synth.waitForPlayerStopped(),await this.synth.waitForVoicesStopped(),this.state="paused",this.finished=!0,this.noCallback||(player.seekTo(0),this.stopCallback()),this.noCallback=!1}async start(e,t){e&&await this.loadNoteSequence(e),t&&this.seekTo(t),this.restart()}stop(){this.noCallback=!0,this.synth&&this.synth.stopPlayer()}pause(){this.state="paused",this.noCallback=!0,this.synth.stopPlayer()}resume(e){this.restart(e)}changeVolume(e){e=e/100,this.synth.setGain(e)}changeMute(e){e?(this.prevGain=this.synth.getGain(),this.synth.setGain(0)):this.synth.setGain(this.prevGain)}calcTick(e){const t=this.midi.duration,n=this.midi.durationTicks;return Math.floor(n*e/t)}seekTo(e){const t=this.calcTick(e);this.synth.seekPlayer(t)}isPlaying(){return!!this.synth&&this.synth.isPlaying()}getPlayState(){return this.synth?this.synth.isPlaying()?"started":this.state:"stopped"}}function stopCallback(){clearInterval(timer),currentTime=0,initSeekbar(midi,0),playNext()}function initPlayer(){return new SoundFontPlayer(stopCallback)}function getInstruments(e){const t=new Set;return e.tracks.forEach(e=>{e.channel===10?t.add(128):t.add(e.instrument.number)}),Array.from(t)}async function loadSoundFont(e,t){if(!t){const e=document.getElementById("soundfonts"),n=e.selectedIndex;if(n==0)return;t=e.options[n].value}const n=`https://soundfonts.pages.dev/${t}`,s=getInstruments(midi);await e.loadSoundFontDir(s,n),await e.loadNoteSequence(midi);const o=document.querySelectorAll("#midiList .play");o.forEach(e=>e.disabled=!1)}function setTimer(e){const t=100,n=Date.now()-e*1e3,s=midi.duration;clearInterval(timer),timer=setInterval(()=>{const e=(Date.now()-n)/1e3;Math.floor(currentTime)!=Math.floor(e)&&updateSeekbar(e),currentTime=e,currentTime>=s&&clearInterval(timer)},t)}function setLoadingTimer(e){const t=setInterval(()=>{player.isPlaying()&&(clearInterval(t),player.seekTo(e),setTimer(e),enableController())},10)}function disableController(){controllerDisabled=!0;const e=document.getElementById("controller").querySelectorAll("button, input");[...e].forEach(e=>{e.disabled=!0})}function enableController(){controllerDisabled=!1;const e=document.getElementById("controller").querySelectorAll("button, input");[...e].forEach(e=>{e.disabled=!1})}function speedDown(){player.isPlaying()&&disableController();const e=document.getElementById("speed"),t=parseInt(e.value)-10,n=t<0?1:t;e.value=n,changeSpeed(n)}function speedUp(){player.isPlaying()&&disableController();const e=document.getElementById("speed"),t=parseInt(e.value)+10;e.value=t,changeSpeed(t)}async function changeSpeed(e){if(!midi)return;const n=player.getPlayState();player.stop(),clearInterval(timer);const s=midiCache.duration/midi.duration,o=s/(e/100),t=currentTime*o;setSpeed(midi,e),initSeekbar(midi,t),n=="started"?(setLoadingTimer(t),player.start(midi)):player instanceof SoundFontPlayer&&(await player.loadNoteSequence(midi),player.seekTo(t))}function changeSpeedEvent(e){player.isPlaying()&&disableController();const t=parseInt(e.target.value);changeSpeed(t)}function setSpeed(e,t){t<=0&&(t=1),t/=100;const n=e.header.tempos;midiCache.header.tempos.forEach((e,s)=>{n[s].bpm=e.bpm*t})}function repeat(){document.getElementById("repeat").classList.toggle("active")}function volumeOnOff(){const t=document.getElementById("volumeOnOff").firstElementChild,e=document.getElementById("volumebar");t.classList.contains("bi-volume-up-fill")?(t.className="bi bi-volume-mute-fill",e.dataset.value=e.value,e.value=0,player.changeMute(!0)):(t.className="bi bi-volume-up-fill",e.value=e.dataset.value,player.changeMute(!1))}function changeVolumebar(){const e=document.getElementById("volumebar"),t=e.value;e.dataset.value=t,player.changeVolume(t)}function formatTime(e){e=Math.floor(e);const n=e%60,t=(e-n)/60,s=(e-n-60*t)/3600,o=String(n).padStart(2,"0"),i=t>9||!s?`${t}:`:`0${t}:`,a=s?`${s}:`:"";return`${a}${i}${o}`}function changeSeekbar(e){clearInterval(timer),currentTime=parseInt(e.target.value),document.getElementById("currentTime").textContent=formatTime(currentTime),player.getPlayState()=="started"&&(player.seekTo(currentTime),setTimer(currentTime))}function updateSeekbar(e){const t=document.getElementById("seekbar");t.value=e;const n=formatTime(e);document.getElementById("currentTime").textContent=n}function initSeekbar(e,t){const n=e.duration;document.getElementById("seekbar").max=n,document.getElementById("seekbar").value=t,document.getElementById("totalTime").textContent=formatTime(n),document.getElementById("currentTime").textContent=formatTime(t)}function setControlChanges(e){e.tracks.forEach(e=>{const t=e.controlChanges;delete t[0],delete t[32],e.addCC({number:121,ticks:0,value:0})})}function addWaitTicks(e){const t=1;e.header.tempos.forEach(e=>{e.ticks+=t}),e.tracks.forEach(e=>{e.notes.forEach(e=>{e.ticks+=t})})}async function loadMIDI(e){midi=await Midi.fromUrl(e),setControlChanges(midi),addWaitTicks(midi),midiCache=midi.clone()}async function loadSoundFontFileEvent(e){if(player){document.getElementById("soundfonts").options[0].selected=!0;const t=e.target.files[0],n=await t.arrayBuffer();await player.loadSoundFontBuffer(n)}}async function loadSoundFontUrlEvent(e){if(player){document.getElementById("soundfonts").options[0].selected=!0;const t=await fetch(e.target.value),n=await t.arrayBuffer();await player.loadSoundFontBuffer(n)}}function unlockAudio(){if(!player)return;if(!player.synth)return;player.resumeContext(),document.removeEventListener("pointerdown",unlockAudio),document.removeEventListener("keydown",unlockAudio)}async function playMIDI(e){disableController(),clearInterval(timer),setNoteInstruments(midi),player instanceof SoundFontPlayer&&await loadSoundFont(player);const t=parseInt(document.getElementById("speed").value);setSpeed(midi,t);const n=parseInt(document.getElementById("volumebar").value);player.changeVolume(n),setLoadingTimer(e),player.start(midi),initSeekbar(midi,e),enableController()}function playNext(){const t=$table[0].querySelector("tbody"),n=t.querySelector(".bi-pause-fill"),s=n.parentNode.parentNode.parentNode,o=[...t.children].indexOf(s);n.className="bi bi-play-fill";const e=$table.bootstrapTable("getData",{useCurrentPage:!0});if(o+1==e.length){const t=$table.bootstrapTable("getData");if(t.at(-1)==e.at(-1)){{const e=document.getElementById("repeat"),t=e.classList.contains("active");if(t){$table.bootstrapTable("selectPage",1);const t=$table.bootstrapTable("getData",{useCurrentPage:!0}),n=$table[0].querySelector("tbody"),e=n.querySelector(".bi-play-fill");e&&play(e,t[0])}}}else{$table.bootstrapTable("nextPage");const t=$table.bootstrapTable("getData",{useCurrentPage:!0}),n=$table[0].querySelector("tbody"),e=n.querySelector(".bi-play-fill");e&&play(e,t[0])}}else{const t=s.nextElementSibling.querySelector(".bi-play-fill");t&&play(t,e[o+1])}}function setNoteInstruments(e){const t=document.getElementById("instruments").selectedIndex-1;t>=0?e.tracks.forEach(e=>e.instrument.number=t):e.tracks.forEach((e,t)=>{e.instrument.number=midiCache.tracks[t].instrument.number})}async function loadSoundFontList(){const e=await fetch("https://soundfonts.pages.dev/list.json"),t=await e.json(),n=document.getElementById("soundfonts");t.forEach(e=>{const t=document.createElement("option");t.textContent=e.name,e.name=="GeneralUser_GS_v1.471"&&(t.selected=!0),n.appendChild(t)})}async function loadInstrumentList(){const e=document.getElementById("lang"),n=e.options[e.selectedIndex].value,s=document.getElementById("instruments"),o=await fetch(`/free-midi/${n}/instruments.lst`),i=await o.text(),t=[];return i.trimEnd().split(`
`).forEach(e=>{const n=document.createElement("option");n.textContent=e,s.appendChild(n),t.push(e)}),t}async function changeConfig(){switch(player.getPlayState()){case"started":{player.stop(),setNoteInstruments(midi),player instanceof SoundFontPlayer&&await loadSoundFont(player);const t=parseInt(document.getElementById("speed").value);setSpeed(midi,t);const e=parseInt(document.getElementById("seekbar").value);initSeekbar(midi,e),setLoadingTimer(e),player.start(midi);break}case"paused":configChanged=!0;break}}function addFilterControl(){const e=document.querySelectorAll("#midiList > thead > tr > th");[...e].slice(2).forEach(e=>{const n=e.dataset.field,o=e.querySelector("div.fht-cell"),t=document.createElement("input");t.title=`search ${n}`,t.type="search",t.className="form-control";const s=getFilterPlaceholder(n);s&&(t.placeholder=s),t.onchange=()=>{filterTable(n,t.value)},o.replaceChildren(t)})}function getFilterPlaceholder(e){switch(e){case"born":return">1850";case"died":return"<1920";case"difficulty":return"<50";case"bpm":return"<120";case"time":return">30(sec)"}}function getFilterFunction(e){switch(e){case"born":case"died":case"difficulty":case"bpm":return filterByRange;case"time":return filterByTime;default:return filterByPartialMatch}}function filterTable(e,t){filterTexts.set(e,t),$table.bootstrapTable("filterBy",{},{filterAlgorithm:e=>{let t=!0;for(const[n,s]of filterTexts.entries()){if(s=="")continue;const o=getFilterFunction(n),i=o(s,e[n]);if(!i){t=!1;break}}return t}})}function filterByPartialMatch(e,t){return!!t&&t.toLowerCase().includes(e.toLowerCase())}function filterByRange(e,t){switch(e[0]){case">":return e.length==1||parseInt(t)>parseInt(e.slice(1));case"<":return e.length==1||parseInt(t)<parseInt(e.slice(1));default:return t==e}}function filterByTime(e,t){const[s,o]=t.split(":"),n=parseInt(s)*60+parseInt(o);switch(e[0]){case">":return e.length==1||n>parseInt(e.slice(1));case"<":return e.length==1||n<parseInt(e.slice(1));default:return t==e}}function toString(e){return e||""}function toLink(e,t){return e?`<a href="${e}">${t}</a>`:t}function toWeb(e){const n=e.split("/")[0],t=collections.get(n),s=t.web,o=t.name;return`<a href="${s}">${o}</a>`}function toLicense(e,t){if(!e){const n=t.split("/")[0],s=collections.get(n);e=s.license}try{return new URL(e),toLink(e,"Custom")}catch{return e}}function toDownload(e,t,n){if(n!=null)switch(t){case"ja":return"HP からダウンロードしてください。";case"en":return"Please download from the homepage."}else return toLink(e,"MIDI")}function toURLSearchParams(e){const n=`${midiDB}/${e.file}`,t=new URLSearchParams;t.set("url",n),e.title&&t.set("title",e.title),e.composer&&t.set("composer",e.composer),e.maintainer&&t.set("maintainer",e.maintainer),e.web&&t.set("web",e.web);try{new URL(e.license)}catch{t.set("license",e.license)}return t}function _detailFormatter(e,t){const s=document.getElementById("detail-box").content.firstElementChild.cloneNode(!0),f=`${midiDB}/${t.file}`,m=toURLSearchParams(t),h=m.toString();for(const e of s.querySelectorAll(".basicInfo a"))e.href+=`?${h}`;const n=s.querySelectorAll(".musicInfo td");n[0].textContent=toString(t.title),n[1].textContent=toString(t.composer),n[2].textContent=toString(t.opus),n[3].textContent=toString(t.lyricist),n[4].textContent=toString(t.date),n[5].textContent=toString(t.style),n[6].textContent=toString(t.arranger),n[7].textContent=toString(t.source);const c=toLicense(t.license,t.file),r=toWeb(t.file),l=t.file.split("/")[0],d=collections.get(l).redistribution,u=toDownload(f,"en",d),o=s.querySelectorAll(".fileInfo td");o[0].innerHTML=c,o[1].innerHTML=u,o[2].textContent=toString(t.maintainer),o[3].textContent=toString(t.email),o[4].innerHTML=r;let a="";t.instruments.split(", ").forEach(e=>{a+=`<li>${e}</li>`});const i=s.querySelectorAll(".annotationInfo td");return i[0].textContent=t.time,i[1].textContent=t.difficulty,i[2].textContent=t.bpm,i[3].innerHTML=`<ul>${a}</ul>`,s}globalThis.toolEvents={"click .bi-play-fill":(e,t,n)=>{switch(e.target.className){case"bi bi-play-fill":{const t=document.querySelectorAll("#midiList .play");return t.forEach(e=>e.disabled=!0),play(e.target,n)}case"bi bi-play":return replay(e.target);case"bi bi-pause-fill":return pause(e.target)}}};function _toolFormatter(){const s=document.getElementById("play-button").content.firstElementChild.cloneNode(!0);return player.loadedLibraries||(s.disabled=!0),s.outerHTML}function play(e,t){if(!e){const n=$table.bootstrapTable("getData",{useCurrentPage:!0});e=document.querySelector("#midiList td:nth-child(2) i"),t=n[0]}const n=$table[0].querySelectorAll("tbody .bi-pause-fill, .bi-play");if([...n].forEach(e=>{e.className="bi bi-play-fill"}),!player)return;player.synth&&player.stop(),e.className="bi bi-pause-fill";const s=`${midiDB}/${t.file}`;loadMIDI(s).then(()=>{playMIDI(0)})}function replay(e){if(!e){const t="#midiList td:nth-child(2) i[class='bi bi-play']";e=document.querySelector(t)}if(e.className="bi bi-pause-fill",configChanged){player.stop();const e=parseInt(document.getElementById("seekbar").value),t=document.getElementById("speed"),n=t.value/100;playMIDI(e/n),configChanged=!1}else player.resume(currentTime),setTimer(currentTime)}function pause(e){if(!e){const t="#midiList td:nth-child(2) i[class='bi bi-pause-fill']";e=document.querySelector(t)}e.className="bi bi-play",player.pause(),clearInterval(timer)}function getInstrumentsString(e,t){const n=t.instruments.split(",").map(e=>parseInt(e));return n.map(t=>e[t]).join(", ")}function typeEvent(e){if(!player)return;if(controllerDisabled)return;switch(player.resumeContext(),e.code){case"Space":switch(e.preventDefault(),player.getPlayState()){case"paused":return replay();case"started":return pause();case"stopped":return play()}break}}function initFilterTexts(){const e=new Map,t=document.querySelectorAll("#midiList > thead > tr > th");return[...t].slice(1).forEach(t=>{const n=t.dataset.field;e.set(n,"")}),e}async function fetchCollections(){const e=await fetch(`${midiDB}/collections.json`);return await e.json()}function shuffle(e){for(let t=e.length;1<t;t--){const n=Math.floor(Math.random()*t);[e[n],e[t-1]]=[e[t-1],e[n]]}return e}function complementTable(e,t){const n=e.country,s=e.composer,o=e.maintainer,i=e.web,a=e.license;t.forEach(e=>{!e.country&&n&&(e.country=n),!e.composer&&s&&(e.composer=s),!e.maintainer&&o&&(e.maintainer=o),e.web||(e.web=i),e.license||(e.license=a)})}async function fetchPlayList(e){const t=Array.from(e.values());shuffle(t);const s=document.documentElement.lang,o=await loadInstrumentList(),i=await fetch(`${midiDB}/json/${t[0].id}/${s}.json`),n=await i.json();complementTable(t[0],n),$table.bootstrapTable("load",n),addFilterControl(),n.forEach(e=>{e.instruments=getInstrumentsString(o,e)}),document.getElementById("midiList").style.height="auto";const a=t.slice(1).map(async e=>{const t=await fetch(`${midiDB}/json/${e.id}/${s}.json`);return t.json()});Promise.all(a).then(e=>{e.forEach((e,n)=>{complementTable(t[n+1],e),$table.bootstrapTable("append",e),addFilterControl(),e.forEach(e=>{e.instruments=getInstrumentsString(o,e)})});const n=document.querySelector(".buttons-toolbar");[...n.querySelectorAll("input")].forEach(e=>{e.addEventListener("change",addFilterControl)});const s=n.children[1].querySelector("button");s.addEventListener("click",()=>{$table.bootstrapTable("filterBy",{},{filterAlgorithm:()=>!0}),filteredInstrumentNode.classList.remove("checked"),filteredCollectionNode.classList.remove("checked")})})}function addCollectionSelector(){const e=document.getElementById("collections");collections.forEach(t=>{const n=document.createElement("button");t.status=="CLOSED"?n.className="btn btn-sm btn-outline-secondary m-1":n.className="btn btn-sm btn-outline-primary m-1",n.type="button",n.textContent=t.name,n.onclick=()=>{let e=t.id;filteredCollectionNode==n?(n.classList.remove("checked"),e=""):(n.classList.add("checked"),filteredCollectionNode&&filteredCollectionNode.classList.remove("checked"));const s=document.getElementById("midiList").querySelector("thead > tr > th[data-field='file'] input");s&&(s.value=e),filterTable("file",e),filteredCollectionNode=n},e.appendChild(n)})}function loadLibraries(e){const t=e.map(e=>new Promise((t,n)=>{const s=document.createElement("script");s.src=e,s.async=!0,s.onload=t,s.onerror=n,document.body.appendChild(s)}));return Promise.all(t)}function setFilterInstrumentsButtons(){const t=document.documentElement.lang,n=t=="en"?["Piano","Accordion","Violin","Guitar","Trumpet","Sax"]:["ピアノ","アコーディオン","ヴァイオリン","ギター","トランペット","サックス"],e=document.getElementById("midiList").querySelector("thead > tr > th[data-field='instruments'] input"),s=document.getElementById("filterInstruments").getElementsByTagName("button");[...s].forEach((t,s)=>{t.onclick=()=>{let o=n[s];filteredInstrumentNode==t?(t.classList.remove("checked"),o=""):(t.classList.add("checked"),filteredInstrumentNode&&filteredInstrumentNode.classList.remove("checked")),e&&(e.value=o),filterTable("instruments",o),filteredInstrumentNode=t}})}async function loadPlayerLibraries(){await player.loadLibraries(),document.querySelectorAll("#midiList .play").forEach(e=>{e.disabled=!1})}loadConfig(),Module={};const midiDB="https://midi-db.pages.dev",$table=$("#midiList"),filterTexts=initFilterTexts(),collections=new Map,player=initPlayer();let controllerDisabled,currentTime=0,midi,midiCache,configChanged=!1,timer,filteredInstrumentNode,filteredCollectionNode;setFilterInstrumentsButtons(),fetchCollections().then(e=>{e.forEach(e=>{collections.set(e.id,e)}),addCollectionSelector(),fetchPlayList(e)}),loadSoundFontList(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("lang").onchange=changeLang,document.getElementById("speed").onchange=changeSpeedEvent,document.getElementById("speedDown").onclick=speedDown,document.getElementById("speedUp").onclick=speedUp,document.getElementById("repeat").onclick=repeat,document.getElementById("volumeOnOff").onclick=volumeOnOff,document.getElementById("volumebar").onchange=changeVolumebar,document.getElementById("seekbar").onchange=changeSeekbar,document.getElementById("instruments").onchange=changeConfig,document.getElementById("soundfonts").onchange=changeConfig,document.getElementById("inputSoundFontFile").onchange=loadSoundFontFileEvent,document.getElementById("inputSoundFontUrl").onchange=loadSoundFontUrlEvent,document.addEventListener("keydown",typeEvent),document.addEventListener("pointerdown",unlockAudio,{once:!0}),document.addEventListener("keydown",unlockAudio,{once:!0}),document.addEventListener("pointerdown",loadPlayerLibraries,{once:!0}),document.addEventListener("keydown",loadPlayerLibraries,{once:!0})